apiVersion: apps/v1
kind: Deployment
metadata:
  name: minecraft-server
  labels:
    app: minecraft
spec:
  replicas: 1
  selector:
    matchLabels:
      app: minecraft
  template:
    metadata:
      labels:
        app: minecraft
    spec:
      containers:
        # 1. Main Minecraft Server
        - name: minecraft
          image: itzg/minecraft-server:java17
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 25565
              name: minecraft
          env:
            - name: EULA
              value: "TRUE"
            - name: TYPE
              value: "PAPER"
            - name: ONLINE_MODE
              value: "FALSE"
          volumeMounts:
            - name: minecraft-data
              mountPath: /data
          resources:
            requests:
              memory: "2Gi"
              cpu: "500m"
            limits:
              memory: "4Gi"
              cpu: "2000m"

        # 2. Sidecar Log Parser (업데이트됨)
        - name: log-parser
          image: kubedutch-parser:latest
          imagePullPolicy: Never # 로컬(Minikube) 빌드 이미지 사용 강제
          env:
            - name: RPC_URL
              valueFrom:
                secretKeyRef:
                  name: minecraft-secret
                  key: RPC_URL
            - name: PRIVATE_KEY
              valueFrom:
                secretKeyRef:
                  name: minecraft-secret
                  key: PRIVATE_KEY
            - name: CONTRACT_ADDRESS
              valueFrom:
                secretKeyRef:
                  name: minecraft-secret
                  key: CONTRACT_ADDRESS
          volumeMounts:
            - name: minecraft-data
              mountPath: /logs
              readOnly: true # 로그 읽기 전용

      volumes:
        - name: minecraft-data
          persistentVolumeClaim:
            claimName: minecraft-pvc
